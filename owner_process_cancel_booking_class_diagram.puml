@startuml Owner Process Request Cancel Booking - Class Diagram

!define ENTITY_COLOR #E1F5FE
!define CONTROLLER_COLOR #FFF3E0
!define MIDDLEWARE_COLOR #F3E5F5
!define UTIL_COLOR #E8F5E8

' Frontend Components
package "Frontend Components" {
    class CancelRequests <<React Component>> ENTITY_COLOR {
        +state: cancelRequests[]
        +state: loading
        +state: selectedRequest
        +state: showModal
        +state: actionType
        +state: reason
        --
        +fetchCancelRequests(): Promise<void>
        +handleApproveCancel(requestId): void
        +handleRejectCancel(requestId): void
        +handleConfirmAction(): Promise<void>
        +showConfirmModal(action, request): void
        +handleCloseModal(): void
        +validateRejectionReason(): boolean
        +render(): JSX.Element
    }
    
    class ConfirmationModal <<React Component>> ENTITY_COLOR {
        +props: isOpen, actionType, onConfirm, onCancel
        +state: reason
        --
        +handleReasonChange(value): void
        +handleSubmit(): void
        +validateInput(): boolean
        +render(): JSX.Element
    }
}

' Backend Routes
package "Backend Routes" {
    class OwnerDashboardRoute <<Express Router>> CONTROLLER_COLOR {
        +POST /cancel-requests/:id/approve
        +POST /cancel-requests/:id/reject
        --
        +setupApprovalRoute(): void
        +setupRejectionRoute(): void
        +validateRequestParams(): middleware
    }
}

' Middleware
package "Middleware" {
    class verifyJWTToken <<Middleware>> MIDDLEWARE_COLOR {
        +verify(req, res, next): void
        +extractUserId(token): number
        +validateToken(token): boolean
        +handleTokenExpiry(): void
    }
    
    class requireOwner <<Middleware>> MIDDLEWARE_COLOR {
        +checkOwnerRole(req, res, next): void
        +validateOwnerPermissions(userId): boolean
        +verifyVehicleOwnership(ownerId, vehicleId): boolean
    }
    
    class validateCancellationRequest <<Middleware>> MIDDLEWARE_COLOR {
        +validateRequestId(req, res, next): void
        +checkRequestExists(requestId): boolean
        +validateRequestStatus(request): boolean
    }
}

' Controllers
package "Controllers" {
    class OwnerDashboardController <<Controller>> CONTROLLER_COLOR {
        +approveCancelRequest(req, res): Promise<void>
        +rejectCancelRequest(req, res): Promise<void>
        --
        -validateOwnership(ownerId, cancellation): boolean
        -validateCancellationStatus(cancellation): boolean
        -calculateRefundAmounts(booking, cancellationFee): object
        -updateBookingStatus(bookingId, status, transaction): Promise<void>
        -updateCancellationStatus(cancellation, status, transaction): Promise<void>
        -createNotifications(booking, action, reason, transaction): Promise<void>
        -handleApprovalProcess(cancellation, transaction): Promise<void>
        -handleRejectionProcess(cancellation, reason, transaction): Promise<void>
    }
}

' Models
package "Database Models" {
    class Booking <<Model>> ENTITY_COLOR {
        +booking_id: number
        +renter_id: number
        +vehicle_id: number
        +start_date: Date
        +end_date: Date
        +total_amount: decimal
        +total_paid: decimal
        +status: enum
        +reward_points_used: number
        +created_at: Date
        +updated_at: Date
        --
        +findByPk(id, options): Promise<Booking>
        +update(data, options): Promise<void>
        +belongsTo(User): Association
        +belongsTo(Vehicle): Association
        +hasOne(BookingCancellation): Association
    }
    
    class BookingCancellation <<Model>> ENTITY_COLOR {
        +cancellation_id: number
        +booking_id: number
        +cancelled_by: enum
        +cancellation_reason: string
        +cancelled_at: Date
        +cancellation_fee: decimal
        +total_refund_for_renter: decimal
        +total_refund_for_owner: decimal
        +refund_status_renter: enum
        +refund_status_owner: enum
        +refund_reason_renter: string
        +refund_processed_at_renter: Date
        +refund_processed_at_owner: Date
        +created_at: Date
        +updated_at: Date
        --
        +findByPk(id, options): Promise<BookingCancellation>
        +update(data, options): Promise<void>
        +belongsTo(Booking): Association
    }
    
    class Vehicle <<Model>> ENTITY_COLOR {
        +vehicle_id: number
        +owner_id: number
        +model: string
        +license_plate: string
        +main_image_url: string
        +status: enum
        +created_at: Date
        --
        +findByPk(id): Promise<Vehicle>
        +belongsTo(User): Association
        +hasMany(Booking): Association
    }
    
    class User <<Model>> ENTITY_COLOR {
        +user_id: number
        +full_name: string
        +email: string
        +phone_number: string
        +role: enum
        +reward_points: number
        +created_at: Date
        --
        +findByPk(id): Promise<User>
        +update(data, options): Promise<void>
        +hasMany(Booking): Association
        +hasMany(Vehicle): Association
        +hasMany(Notification): Association
    }
    
    class Notification <<Model>> ENTITY_COLOR {
        +notification_id: number
        +user_id: number
        +title: string
        +content: string
        +type: enum
        +is_read: boolean
        +created_at: Date
        --
        +create(data, options): Promise<Notification>
        +findAll(options): Promise<Notification[]>
        +update(data, options): Promise<void>
        +belongsTo(User): Association
    }
}

' Services
package "Services" {
    class NotificationService <<Service>> UTIL_COLOR {
        +createRenterNotification(booking, action, reason, transaction): Promise<void>
        +createAdminNotification(booking, action, transaction): Promise<void>
        +createOwnerNotification(booking, action, transaction): Promise<void>
        --
        -formatNotificationContent(booking, action, reason): string
        -getNotificationTitle(action): string
        -determineNotificationType(action): string
    }
    
    class RefundCalculationService <<Service>> UTIL_COLOR {
        +calculateRefundAmounts(booking, cancellationFee): object
        +calculateCancellationFee(booking, cancelledAt): decimal
        +validateRefundEligibility(booking): boolean
        --
        -CANCELLATION_FEE_RATES: object
        -calculateRenterRefund(totalPaid, cancellationFee): decimal
        -calculateOwnerCompensation(totalAmount, cancellationFee): decimal
    }
    
    class ValidationService <<Service>> UTIL_COLOR {
        +validateOwnership(ownerId, cancellation): boolean
        +validateCancellationStatus(cancellation): boolean
        +validateRequestTiming(booking): boolean
        +validateRejectionReason(reason): boolean
        --
        -VALID_CANCELLATION_STATUSES: string[]
        -MIN_REASON_LENGTH: number
        -MAX_REASON_LENGTH: number
    }
}

' Utilities
package "Utilities" {
    class DatabaseTransaction <<Utility>> UTIL_COLOR {
        +beginTransaction(): Promise<Transaction>
        +commitTransaction(transaction): Promise<void>
        +rollbackTransaction(transaction): Promise<void>
        +executeInTransaction(callback): Promise<any>
        --
        -handleTransactionError(error, transaction): Promise<void>
        -logTransactionActivity(action, transaction): void
    }
    
    class ErrorHandler <<Utility>> UTIL_COLOR {
        +handleValidationError(error, res): void
        +handleDatabaseError(error, res): void
        +handleAuthorizationError(res): void
        +handleNotFoundError(res): void
        --
        -formatErrorResponse(error): object
        -logError(error, context): void
    }
}

' Relationships
CancelRequests --> ConfirmationModal : "renders"
CancelRequests --> OwnerDashboardRoute : "API calls"

OwnerDashboardRoute --> verifyJWTToken : "uses"
OwnerDashboardRoute --> requireOwner : "uses"
OwnerDashboardRoute --> validateCancellationRequest : "uses"
OwnerDashboardRoute --> OwnerDashboardController : "delegates to"

OwnerDashboardController --> Booking : "queries & updates"
OwnerDashboardController --> BookingCancellation : "queries & updates"
OwnerDashboardController --> Vehicle : "queries"
OwnerDashboardController --> User : "queries"
OwnerDashboardController --> Notification : "creates"
OwnerDashboardController --> NotificationService : "uses"
OwnerDashboardController --> RefundCalculationService : "uses"
OwnerDashboardController --> ValidationService : "uses"
OwnerDashboardController --> DatabaseTransaction : "uses"
OwnerDashboardController --> ErrorHandler : "uses"

Booking --> User : "belongsTo (renter)"
Booking --> Vehicle : "belongsTo"
Booking --> BookingCancellation : "hasOne"
Vehicle --> User : "belongsTo (owner)"
BookingCancellation --> Booking : "belongsTo"
Notification --> User : "belongsTo"

note top of CancelRequests
Frontend component for owners to:
- View pending cancel requests
- Approve requests (sets refund status to pending)
- Reject requests with reason
- Show confirmation modals
- Handle success/error responses
end note

note top of OwnerDashboardController
Main controller handling owner actions:
- Validate ownership and request status
- Approve: Update booking to 'cancelled', 
  set refund status to 'pending'
- Reject: Update booking to 'fully_paid',
  set refund status to 'rejected'
- Create notifications for all parties
- Use database transactions
end note

note bottom of RefundCalculationService
Calculates refund amounts based on:
- Cancellation timing (hours before start)
- Cancellation fee rates
- Total amount paid vs total booking cost
- Separate amounts for renter and owner
end note

note bottom of BookingCancellation
Tracks cancellation process:
- Initial request by renter
- Owner approval/rejection
- Refund status for both parties
- Separate processing for renter/owner refunds
- Admin approval required for actual refunds
end note

@enduml