@startuml View List Cancel Booking - Class Diagram

!define ENTITY_COLOR #E1F5FE
!define CONTROLLER_COLOR #FFF3E0
!define MIDDLEWARE_COLOR #F3E5F5
!define UTIL_COLOR #E8F5E8

' Frontend Components
package "Frontend Components" {
    class CancelRequests <<React Component>> ENTITY_COLOR {
        +state: cancelRequests[]
        +state: loading
        +state: selectedRequest
        +state: showModal
        +state: actionType
        +state: reason
        --
        +useEffect(): void
        +fetchCancelRequests(): Promise<void>
        +handleApproveCancel(requestId): void
        +handleRejectCancel(requestId): void
        +handleConfirmAction(): Promise<void>
        +handleCloseModal(): void
        +formatCurrency(amount): string
        +formatDate(date): string
        +render(): JSX.Element
    }
    
    class BookingHistoryTable <<React Component>> ENTITY_COLOR {
        +props: bookings[]
        +state: showCancelModal
        +state: selectedBooking
        --
        +handleCancelClick(booking): void
        +handleCancelSuccess(): void
        +render(): JSX.Element
    }
}

' Backend Route
package "Backend Routes" {
    class OwnerDashboardRoute <<Express Router>> CONTROLLER_COLOR {
        +GET /cancel-requests
        +POST /cancel-requests/:id/approve
        +POST /cancel-requests/:id/reject
        +GET /cancelled-bookings
        --
        +setupRoutes(): void
    }
}

' Middleware
package "Middleware" {
    class verifyJWTToken <<Middleware>> MIDDLEWARE_COLOR {
        +verify(req, res, next): void
        +extractUserId(token): number
        +validateToken(token): boolean
    }
    
    class requireOwner <<Middleware>> MIDDLEWARE_COLOR {
        +checkOwnerRole(req, res, next): void
        +validateOwnerPermissions(userId): boolean
    }
}

' Controllers
package "Controllers" {
    class OwnerDashboardController <<Controller>> CONTROLLER_COLOR {
        +getCancelRequests(req, res): Promise<void>
        +approveCancelRequest(req, res): Promise<void>
        +rejectCancelRequest(req, res): Promise<void>
        +getCancelledBookings(req, res): Promise<void>
        --
        -calculateRefundAmounts(booking, cancellationFee): object
        -createNotifications(booking, status, reason): Promise<void>
        -updateBookingStatus(bookingId, status): Promise<void>
    }
    
    class BookingController <<Controller>> CONTROLLER_COLOR {
        +deleteBooking(req, res): Promise<void>
        --
        -validateBookingStatus(booking): boolean
        -refundRewardPoints(userId, points): Promise<void>
        -createCancellationRecord(booking, reason): Promise<void>
    }
}

' Models
package "Database Models" {
    class Booking <<Model>> ENTITY_COLOR {
        +booking_id: number
        +renter_id: number
        +vehicle_id: number
        +start_date: Date
        +end_date: Date
        +total_amount: decimal
        +total_paid: decimal
        +status: enum
        +reward_points_used: number
        +created_at: Date
        +updated_at: Date
        --
        +findByPk(id): Promise<Booking>
        +findAll(options): Promise<Booking[]>
        +update(data): Promise<void>
        +destroy(): Promise<void>
    }
    
    class BookingCancellation <<Model>> ENTITY_COLOR {
        +cancellation_id: number
        +booking_id: number
        +cancelled_by: enum
        +cancellation_reason: string
        +cancelled_at: Date
        +cancellation_fee: decimal
        +total_refund_for_renter: decimal
        +total_refund_for_owner: decimal
        +refund_status_renter: enum
        +refund_status_owner: enum
        +refund_reason_renter: string
        +refund_processed_at_renter: Date
        +refund_processed_at_owner: Date
        +created_at: Date
        --
        +create(data): Promise<BookingCancellation>
        +findAll(options): Promise<BookingCancellation[]>
        +update(data): Promise<void>
    }
    
    class Vehicle <<Model>> ENTITY_COLOR {
        +vehicle_id: number
        +owner_id: number
        +model: string
        +license_plate: string
        +main_image_url: string
        +status: enum
        --
        +findByPk(id): Promise<Vehicle>
        +belongsTo(User): Association
    }
    
    class User <<Model>> ENTITY_COLOR {
        +user_id: number
        +full_name: string
        +email: string
        +phone_number: string
        +role: enum
        +reward_points: number
        +created_at: Date
        --
        +findByPk(id): Promise<User>
        +update(data): Promise<void>
        +hasMany(Booking): Association
        +hasMany(Vehicle): Association
    }
    
    class Notification <<Model>> ENTITY_COLOR {
        +notification_id: number
        +user_id: number
        +title: string
        +content: string
        +type: enum
        +is_read: boolean
        +created_at: Date
        --
        +create(data): Promise<Notification>
        +findAll(options): Promise<Notification[]>
        +update(data): Promise<void>
    }
}

' Utilities
package "Utilities" {
    class CancellationUtils <<Utility>> UTIL_COLOR {
        +calculateCancellationFee(booking, cancelledAt): decimal
        +calculateRefundAmounts(booking, cancellationFee): object
        +validateCancellationEligibility(booking): boolean
        +getTimeUntilStartDate(booking): number
        --
        -CANCELLATION_FEE_RATES: object
        -MIN_CANCELLATION_HOURS: number
    }
    
    class DatabaseTransaction <<Utility>> UTIL_COLOR {
        +beginTransaction(): Promise<Transaction>
        +commitTransaction(transaction): Promise<void>
        +rollbackTransaction(transaction): Promise<void>
        +executeInTransaction(callback): Promise<any>
    }
}

' Relationships
CancelRequests --> OwnerDashboardRoute : "API calls"
BookingHistoryTable --> OwnerDashboardRoute : "API calls"

OwnerDashboardRoute --> verifyJWTToken : "uses"
OwnerDashboardRoute --> requireOwner : "uses"
OwnerDashboardRoute --> OwnerDashboardController : "delegates to"
OwnerDashboardRoute --> BookingController : "delegates to"

OwnerDashboardController --> Booking : "queries"
OwnerDashboardController --> BookingCancellation : "manages"
OwnerDashboardController --> Vehicle : "queries"
OwnerDashboardController --> User : "queries"
OwnerDashboardController --> Notification : "creates"
OwnerDashboardController --> CancellationUtils : "uses"
OwnerDashboardController --> DatabaseTransaction : "uses"

BookingController --> Booking : "manages"
BookingController --> User : "updates"
BookingController --> BookingCancellation : "creates"
BookingController --> DatabaseTransaction : "uses"

Booking --> User : "belongsTo (renter)"
Booking --> Vehicle : "belongsTo"
Vehicle --> User : "belongsTo (owner)"
BookingCancellation --> Booking : "belongsTo"
Notification --> User : "belongsTo"

note top of CancelRequests
Frontend component for owners to view 
and manage cancel requests from renters.
Displays list with booking details, 
cancellation reasons, and refund amounts.
end note

note top of OwnerDashboardController
Main controller handling:
- Get cancel requests for owner
- Approve/reject cancel requests
- Calculate refund amounts
- Create notifications
- Update booking status
end note

note top of CancellationUtils
Utility functions for:
- Calculating cancellation fees based on timing
- Determining refund amounts for renter/owner
- Validating cancellation eligibility
- Time-based fee calculations
end note

note bottom of BookingCancellation
Stores cancellation details including:
- Cancellation reason and timing
- Calculated fees and refund amounts
- Separate refund status for renter/owner
- Processing timestamps
end note

@enduml