@startuml pay_remaining_amount
title Sequence Diagram: Pay Remaining Amount (70%)

actor User as U
participant "Frontend" as F
participant "Payment Route" as PR
participant "Payment Controller" as PC
participant "Booking Model" as BM
participant "PayOS Service" as POS
participant "Transaction Model" as TM
participant "Notification Model" as NM
participant "Email Service" as ES
database "MySQL Database" as DB

U -> F: 1. Nhấn nút "Thanh toán phần còn lại"
F -> PR: 2. POST /api/payment/payos/remaining-link + Cookies\n(withCredentials: true)
PR -> PR: 3. Extract JWT token từ cookies\nVerify token validity (middleware)
PR -> PC: 4. Call createPayOSLinkForRemaining(req, res)
PC -> BM: 5. Tìm booking theo bookingId (include renter)
BM -> DB: 6. SELECT booking WHERE booking_id
DB --> BM: 7. Trả về dữ liệu booking
BM --> PC: 8. Trả về thông tin booking
PC -> PC: 9. Kiểm tra booking.status === "deposit_paid"
alt Booking status hợp lệ
    PC -> PC: 10. Tính deposit = total_amount * 0.3
    PC -> PC: 11. Tính remaining = total_amount - deposit
    PC -> PC: 12. Kiểm tra remaining >= 1000
    alt Số tiền hợp lệ
        PC -> PC: 13. Tạo orderCodeRemaining = Date.now()
        PC -> BM: 14. Cập nhật booking.order_code_remaining
        BM -> DB: 15. UPDATE booking SET order_code_remaining
        DB --> BM: 16. Xác nhận cập nhật
        PC -> PC: 17. Tạo description = "Con lai {orderCodeRemaining}"
        PC -> POS: 18. Tạo payment request với PayOS
        POS --> PC: 19. Trả về checkoutUrl
        PC --> PR: 20. Trả về {payUrl: checkoutUrl}
        PR --> F: 21. Trả về payment response
        F --> U: 22. Hiển thị QR code thanh toán
    else Số tiền không hợp lệ
        PC --> PR: 23. Trả về lỗi "Số tiền phải từ 1.000đ trở lên"
        PR --> F: 24. Trả về error response
    end
else Booking status không hợp lệ
    PC --> PR: 25. Trả về lỗi "Chỉ thanh toán phần còn lại khi đã đặt cọc"
    PR --> F: 26. Trả về error response
end

U -> POS: 27. Quét QR và thanh toán
POS -> PR: 28. POST /api/payment/payos/webhook
PR -> PC: 29. Call handlePayOSWebhook(req, res)

alt Thanh toán thành công
    PC -> BM: 30. Tìm booking theo orderCodeRemaining
    BM -> DB: 31. SELECT booking WHERE order_code_remaining
    DB --> BM: 32. Trả về dữ liệu booking
    BM --> PC: 33. Trả về thông tin booking
    PC -> BM: 34. Cập nhật booking.status = "fully_paid"
    BM -> DB: 35. UPDATE booking SET status="fully_paid"
    DB --> BM: 36. Xác nhận cập nhật
    PC -> TM: 37. Tạo transaction mới
    TM -> DB: 38. INSERT transaction (type="REMAINING_PAYMENT")
    DB --> TM: 39. Trả về transaction_id
    PC -> NM: 40. Tạo thông báo cho renter
    NM -> DB: 41. INSERT notification cho renter
    DB --> NM: 42. Xác nhận tạo notification
    PC -> NM: 43. Tạo thông báo cho owner
    NM -> DB: 44. INSERT notification cho owner
    DB --> NM: 45. Xác nhận tạo notification
    PC -> ES: 46. Gửi email xác nhận thanh toán
    PC --> PR: 47. Trả về response thành công
    PR --> POS: 48. Trả về webhook response
else Thanh toán thất bại
    PC -> PC: 49. Log lỗi webhook
    PC --> PR: 50. Trả về response lỗi
    PR --> POS: 51. Trả về webhook response
end

F -> F: 52. Xử lý kết quả thanh toán (success/cancel)
F --> U: 53. Hiển thị kết quả thanh toán

@enduml