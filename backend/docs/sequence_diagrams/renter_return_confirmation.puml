@startuml renter_return_confirmation
title Renter Return Confirmation - Renter xác nhận ảnh xe sau khi trả xe cho owner

actor "Renter" as Renter
participant "Frontend\n(HandoverImageViewer)" as Frontend
participant "Axios Instance" as Axios
participant "Handover Route\n(/api/handover)" as HandoverRoute
participant "Auth Middleware\n(verifyJWTToken)" as AuthMiddleware
participant "Handover Controller\n(confirmRenterReturn)" as HandoverController
participant "Booking Model" as BookingModel
participant "User Model" as UserModel
participant "BookingHandover Model" as HandoverModel
participant "Vehicle Model" as VehicleModel
database "MySQL Database" as DB

Renter -> Frontend: Xem ảnh xe đã được owner upload sau khi trả
Frontend -> Frontend: Hiển thị post_rental_images từ handoverData
Frontend -> Frontend: Kiểm tra trạng thái:\n- owner_return_confirmed\n- renter_return_confirmed

Renter -> Frontend: Click "Xác nhận ảnh xe" button
Frontend -> Frontend: Set confirming = true\nClear error state

Frontend -> Axios: POST /api/handover/{bookingId}/confirm-renter-return
Axios -> HandoverRoute: Request không có body data + Cookies\n(withCredentials: true)

HandoverRoute -> AuthMiddleware: verifyJWTToken(req, res, next)
AuthMiddleware -> AuthMiddleware: Extract JWT token từ cookies\nVerify token validity
AuthMiddleware -> HandoverRoute: Set req.user.userId = renterId

HandoverRoute -> HandoverController: confirmRenterReturn(req, res)

HandoverController -> BookingModel: findOne({where: {booking_id}, include: User as renter})
BookingModel -> DB: SELECT bookings.* FROM bookings\nJOIN users ON bookings.renter_id = users.user_id\nWHERE booking_id = ? AND users.user_id = ?
DB -> BookingModel: Return booking với renter data
BookingModel -> HandoverController: Return booking object với renter

alt Booking không tồn tại hoặc renter không có quyền
    HandoverController -> Frontend: 404 - "Không tìm thấy booking hoặc bạn không có quyền truy cập"
else Booking tồn tại và renter có quyền
    HandoverController -> HandoverModel: findOne({where: {booking_id}})
    HandoverModel -> DB: SELECT * FROM booking_handovers WHERE booking_id = ?
    DB -> HandoverModel: Return handover data
    HandoverModel -> HandoverController: Return handover object
    
    alt Handover record không tồn tại
        HandoverController -> Frontend: 404 - "Không tìm thấy handover record"
    else Handover record tồn tại
        HandoverModel -> DB: UPDATE booking_handovers SET\nrenter_return_confirmed = true,\nreturn_time = NOW()\nWHERE booking_id = ?
        DB -> HandoverModel: Return updated rows
        HandoverModel -> HandoverController: Return update result
        
        alt Cập nhật handover thất bại
            HandoverController -> Frontend: 400 - "Cập nhật handover record thất bại"
        else Cập nhật handover thành công
            HandoverController -> BookingModel: update({status: "completed"})
            BookingModel -> DB: UPDATE bookings SET status = "completed"\nWHERE booking_id = ?
            DB -> BookingModel: Return updated rows
            BookingModel -> HandoverController: Return update result
            
            alt Cập nhật booking thất bại
                HandoverController -> Frontend: 400 - "Cập nhật booking thất bại"
            else Cập nhật booking thành công
                HandoverController -> VehicleModel: findOne({where: {vehicle_id}})
                VehicleModel -> DB: SELECT * FROM vehicles WHERE vehicle_id = ?
                DB -> VehicleModel: Return vehicle data
                VehicleModel -> HandoverController: Return vehicle object
                
                HandoverController -> VehicleModel: update({rent_count: rent_count + 1})
                VehicleModel -> DB: UPDATE vehicles SET rent_count = rent_count + 1\nWHERE vehicle_id = ?
                DB -> VehicleModel: Return updated rows
                VehicleModel -> HandoverController: Return update result
                
                HandoverController -> Frontend: 200 - {\nsuccess: true,\nmessage: "Xác nhận trả xe thành công",\ndata: {\nhandover_id,\nrenter_return_confirmed: true,\nreturn_time\n}\n}
                Frontend -> Frontend: Set confirming = false\nShow success alert
                Frontend -> Renter: Display success message\n"Xác nhận ảnh xe sau trả xe thành công!"
            end
        end
    end
end

alt Có lỗi xảy ra (catch block)
    HandoverController -> Frontend: 500 - Internal Server Error
    Frontend -> Frontend: Set confirming = false\nSet error message
    Frontend -> Renter: Display error message
end

note over Renter, DB
    Sau khi renter xác nhận trả xe:
    1. Booking status chuyển thành "completed"
    2. Vehicle rent_count tăng lên 1
    3. Quá trình thuê xe hoàn tất
end note

@enduml