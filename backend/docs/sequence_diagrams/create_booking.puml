@startuml create_booking

title Create Booking Sequence Diagram

actor Renter
participant "Detail vehicle detail page" as FE
participant "Axios Instance" as Axios
participant "Auth Middleware" as Auth
participant "Verification Middleware" as Verify
participant "Booking Route" as Route
participant "Booking Controller" as Controller
participant "Vehicle Model" as VehicleModel
participant "User Model" as UserModel
participant "Voucher Model" as VoucherModel
participant "Booking Model" as BookingModel
database "MySQL Database" as DB

Renter -> FE: 1. Điền form booking (vehicle_id, startDate, endDate, startTime, endTime, deliveryOption, etc.)
FE -> FE: 2. Validate dữ liệu form
FE -> Axios: 3. POST /api/booking/createBooking với booking data + Cookies\n(withCredentials: true)
Axios -> Auth: 4. Gửi request với cookies chứa JWT token
Auth -> Auth: 5. Extract JWT token từ cookies\nVerify token validity
Auth -> Verify: 6. Chuyển request đến verification middleware
Verify -> Verify: 7. Kiểm tra trạng thái xác minh tài khoản
Verify -> Route: 8. Chuyển request đến booking route
Route -> Controller: 9. Gọi createBooking function

Controller -> Controller: 10. Xác thực người dùng từ JWT token
Controller -> Controller: 11. Extract và validate dữ liệu đầu vào
Controller -> VehicleModel: 12. Kiểm tra xe có tồn tại
VehicleModel -> DB: 13. SELECT vehicle WHERE vehicle_id = ?
DB -> VehicleModel: 14. Trả về thông tin xe
VehicleModel -> Controller: 15. Thông tin xe hoặc null

alt Xe không tồn tại
    Controller -> Axios: 16a. Response 404 - Không tìm thấy xe
    Axios -> FE: 17a. Hiển thị lỗi
else Xe tồn tại
    Controller -> Controller: 18. Parse và validate thời gian (múi giờ VN)
    Controller -> Controller: 19. Kiểm tra logic thời gian (không trong quá khứ, end > start)
    
    Controller -> BookingModel: 20. Lấy danh sách booking đã tồn tại của xe
    BookingModel -> DB: 21. SELECT bookings WHERE vehicle_id = ? AND status IN (pending, deposit_paid, etc.)
    DB -> BookingModel: 22. Trả về danh sách booking
    BookingModel -> Controller: 23. Danh sách khoảng thời gian đã đặt
    
    Controller -> Controller: 24. Kiểm tra xung đột lịch đặt
    
    alt Có xung đột lịch
        Controller -> Axios: 25a. Response 409 - Thời gian đã được đặt
        Axios -> FE: 26a. Hiển thị lỗi xung đột
    else Không có xung đột
        Controller -> Controller: 27. Tính toán chi phí cơ bản (total_days * price_per_day)
        Controller -> Controller: 28. Xử lý địa điểm và phí giao xe
        
        alt Có voucher code
            Controller -> VoucherModel: 29a. Kiểm tra voucher hợp lệ
            VoucherModel -> DB: 30a. SELECT voucher WHERE code = ? AND is_active = true
            DB -> VoucherModel: 31a. Thông tin voucher
            VoucherModel -> Controller: 32a. Voucher data
            Controller -> Controller: 33a. Validate voucher (thời hạn, usage_limit, min_order)
            Controller -> Controller: 34a. Tính toán discount_amount
        end
        
        alt Sử dụng điểm thưởng
            Controller -> UserModel: 35a. Kiểm tra điểm thưởng của user
            UserModel -> DB: 36a. SELECT points FROM users WHERE user_id = ?
            DB -> UserModel: 37a. Số điểm hiện tại
            UserModel -> Controller: 38a. User points
            Controller -> Controller: 39a. Validate đủ điểm để sử dụng
        end
        
        Controller -> Controller: 40. Tính tổng tiền cuối cùng (subtotal - discount - points)
        
        Controller -> BookingModel: 41. Tạo booking mới
        BookingModel -> DB: 42. INSERT INTO bookings (renter_id, vehicle_id, start_date, end_date, etc.)
        DB -> BookingModel: 43. Booking đã tạo với booking_id
        BookingModel -> Controller: 44. Booking object
        
        alt Có sử dụng điểm thưởng
            Controller -> UserModel: 45a. Cập nhật điểm thưởng user
            UserModel -> DB: 46a. UPDATE users SET points = points - ? WHERE user_id = ?
            DB -> UserModel: 47a. Confirm update
            UserModel -> Controller: 48a. Points updated
        end
        
        Controller -> Axios: 49. Response 201 - Booking created successfully với booking data
        Axios -> FE: 50. Nhận response thành công
        FE -> FE: 51. Cập nhật UI, chuyển hướng đến trang thanh toán
        FE -> Renter: 52. Hiển thị thông tin booking đã tạo
    end
end

@enduml