@startuml create_booking

title Create Booking Sequence Diagram

actor Renter
participant "Vehicle Detail Page" as FE
participant "Axios Instance" as Axios
participant "Auth Middleware" as Auth
participant "Verification Middleware" as Verify
participant "Booking Route" as Route
participant "Booking Controller" as Controller
participant "Vehicle Model" as VehicleModel
participant "User Model" as UserModel
participant "Voucher Model" as VoucherModel
participant "Booking Model" as BookingModel
participant "Notification Model" as NotificationModel
database "MySQL Database" as DB

Renter -> FE: 1. Fill out booking form (vehicle_id, startDate, endDate, startTime, endTime, deliveryOption, etc.)
FE -> FE: 2. Validate form data
FE -> Axios: 3. POST /api/renter/booking/createBooking with booking data + cookies\n(withCredentials: true)
Axios -> Auth: 4. Send request with cookies containing JWT token
Auth -> Auth: 5. Extract JWT token from cookies\nVerify token validity
Auth -> Verify: 6. Forward request to verification middleware
Verify -> Verify: 7. Check account verification status
Verify -> Route: 8. Pass request to booking route
Route -> Controller: 9. Call createBooking function

Controller -> Controller: 10. Authenticate user from JWT token
Controller -> Controller: 11. Extract and validate input data
Controller -> VehicleModel: 12. Check if vehicle exists
VehicleModel -> DB: 13. SELECT vehicle WHERE vehicle_id = ?
DB -> VehicleModel: 14. Return vehicle information
VehicleModel -> Controller: 15. Return vehicle data or null

alt Vehicle not found
    Controller -> Axios: 16a. Response 404 - Vehicle not found
    Axios -> FE: 17a. Display error message
else Vehicle exists
    Controller -> Controller: 18. Parse and validate time (VN timezone)
    Controller -> Controller: 19. Check time logic (not in the past, end > start)
    
    Controller -> BookingModel: 20. Retrieve existing bookings for the vehicle
    BookingModel -> DB: 21. SELECT bookings WHERE vehicle_id = ? AND status IN (pending, deposit_paid, etc.)
    DB -> BookingModel: 22. Return booking list
    BookingModel -> Controller: 23. Return booked time slots
    
    Controller -> Controller: 24. Check for booking time conflicts
    
    alt Conflict detected
        Controller -> Axios: 25a. Response 409 - Selected time slot already booked
        Axios -> FE: 26a. Display conflict error
    else No conflict
        Controller -> Controller: 27. Calculate base cost (total_days * price_per_day)
        Controller -> Controller: 28. Handle delivery location and fees
        
        alt Has voucher code
            Controller -> VoucherModel: 29a. Validate voucher
            VoucherModel -> DB: 30a. SELECT voucher WHERE code = ? AND is_active = true
            DB -> VoucherModel: 31a. Return voucher data
            VoucherModel -> Controller: 32a. Return voucher info
            Controller -> Controller: 33a. Validate voucher (expiration, usage limit, min order)
            Controller -> Controller: 34a. Calculate discount amount
        end
        
        alt Use reward points
            Controller -> UserModel: 35a. Check user reward points
            UserModel -> DB: 36a. SELECT points FROM users WHERE user_id = ?
            DB -> UserModel: 37a. Return current points
            UserModel -> Controller: 38a. Return user points
            Controller -> Controller: 39a. Validate if user has enough points
        end
        
        Controller -> Controller: 40. Calculate final total (subtotal - discount - points)
        
        Controller -> BookingModel: 41. Create new booking
        BookingModel -> DB: 42. INSERT INTO bookings (renter_id, vehicle_id, start_date, end_date, etc.)
        DB -> BookingModel: 43. Return created booking_id
        BookingModel -> Controller: 44. Return booking object
        
        alt Used reward points
            Controller -> UserModel: 45a. Update user points
            UserModel -> DB: 46a. UPDATE users SET points = points - ? WHERE user_id = ?
            DB -> UserModel: 47a. Confirm update
            UserModel -> Controller: 48a. Points updated
        end
        
        ' --- Create notifications ---
        Controller -> NotificationModel: 53. Create notification for vehicle owner
        NotificationModel -> DB: 54. INSERT INTO notifications {user_id: owner_id, title, content, type: "rental", is_read: false}
        DB -> NotificationModel: 55. Confirm insertion
        NotificationModel -> Controller: 56. Notification created

        Controller -> NotificationModel: 57. Create notification for renter
        NotificationModel -> DB: 58. INSERT INTO notifications {user_id: renter_id, title, content, type: "rental", is_read: false}
        DB -> NotificationModel: 59. Confirm insertion
        NotificationModel -> Controller: 60. Notification created

        Controller -> Axios: 61. Response 201 - Booking created successfully with booking data
        Axios -> FE: 62. Receive success response
        FE -> FE: 63. Update UI and redirect to payment page
        FE -> Renter: 64. Display booking confirmation
    end
end

@enduml
