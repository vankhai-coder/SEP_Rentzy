@startuml renter_handover_confirmation
title Renter Handover Confirmation - Renter xác nhận ảnh xe trước khi nhận xe

actor "Renter" as Renter
participant "Frontend\n(HandoverImageViewer)" as Frontend
participant "Axios Instance" as Axios
participant "Handover Route\n(/api/handover)" as HandoverRoute
participant "Auth Middleware\n(verifyJWTToken)" as AuthMiddleware
participant "Handover Controller\n(confirmRenterHandover)" as HandoverController
participant "Booking Model" as BookingModel
participant "User Model" as UserModel
participant "BookingHandover Model" as HandoverModel
database "MySQL Database" as DB

Renter -> Frontend: Xem ảnh xe đã được owner upload
Frontend -> Frontend: Hiển thị pre_rental_images từ handoverData
Frontend -> Frontend: Kiểm tra trạng thái:\n- owner_handover_confirmed\n- renter_handover_confirmed

Renter -> Frontend: Click "Xác nhận ảnh xe" button
Frontend -> Frontend: Set confirming = true\nClear error state

Frontend -> Axios: POST /api/handover/{bookingId}/confirm-renter-handover
Axios -> HandoverRoute: Request không có body data + Cookies\n(withCredentials: true)

HandoverRoute -> AuthMiddleware: verifyJWTToken(req, res, next)
AuthMiddleware -> AuthMiddleware: Extract JWT token từ cookies\nVerify token validity
AuthMiddleware -> HandoverRoute: Set req.user.userId = renterId

HandoverRoute -> HandoverController: confirmRenterHandover(req, res)

HandoverController -> HandoverController: Extract bookingId từ req.params\nExtract renterId từ req.user.userId

HandoverController -> BookingModel: findOne({where: {booking_id}, include: User as renter})
BookingModel -> DB: SELECT bookings.* FROM bookings\nJOIN users ON bookings.renter_id = users.user_id\nWHERE booking_id = ? AND users.user_id = ?
DB -> BookingModel: Return booking với renter data
BookingModel -> HandoverController: Return booking object với renter

alt Booking không tồn tại hoặc renter không có quyền
    HandoverController -> Frontend: 404 - "Không tìm thấy booking hoặc bạn không có quyền truy cập"
else Booking tồn tại và renter có quyền
    HandoverController -> HandoverController: Check booking.status === "fully_paid"
    
    alt Booking chưa được thanh toán đầy đủ
        HandoverController -> Frontend: 400 - "Booking chưa được thanh toán đầy đủ"
    else Booking đã thanh toán đầy đủ
        HandoverController -> HandoverModel: findOne({where: {booking_id}})
        HandoverModel -> DB: SELECT * FROM booking_handovers WHERE booking_id = ?
        DB -> HandoverModel: Return handover data
        HandoverModel -> HandoverController: Return handover object
        
        alt Handover record không tồn tại
            HandoverController -> Frontend: 404 - "Không tìm thấy handover record"
        else Handover record tồn tại
            HandoverController -> HandoverModel: update({\nrenter_handover_confirmed: true,\nhandover_time: new Date()\n})
            HandoverModel -> DB: UPDATE booking_handovers SET\nrenter_handover_confirmed = true,\nhandover_time = NOW()\nWHERE booking_id = ?
            DB -> HandoverModel: Return updated rows
            HandoverModel -> HandoverController: Return update result
            
            alt Cập nhật handover thất bại
                HandoverController -> Frontend: 400 - "Cập nhật handover record thất bại"
            else Cập nhật handover thành công
                HandoverController -> BookingModel: update({status: "in_progress"})
                BookingModel -> DB: UPDATE bookings SET status = "in_progress"\nWHERE booking_id = ?
                DB -> BookingModel: Return updated rows
                BookingModel -> HandoverController: Return update result
                
                alt Cập nhật booking thất bại
                    HandoverController -> Frontend: 400 - "Cập nhật booking thất bại"
                else Cập nhật booking thành công
                    HandoverController -> Frontend: 200 - {\nsuccess: true,\nmessage: "Xác nhận handover record thành công",\ndata: {\nhandover_id,\nrenter_handover_confirmed: true,\nhandover_time\n}\n}
                    Frontend -> Frontend: Set confirming = false\nShow success alert
                    Frontend -> Frontend: Call onConfirmSuccess() callback\nUpdate UI state
                    Frontend -> Renter: Display success message\n"Xác nhận ảnh xe trước bàn giao thành công!"
                end
            end
        end
    end
end

alt Có lỗi xảy ra (catch block)
    HandoverController -> Frontend: 500 - Internal Server Error
    Frontend -> Frontend: Set confirming = false\nSet error message
    Frontend -> Renter: Display error message
end

@enduml