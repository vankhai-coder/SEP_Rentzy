@startuml owner_handover_confirmation
title Owner Handover Confirmation - Đăng ảnh và xác nhận xe bởi owner trước lúc giao

actor "Owner" as Owner
participant "Frontend\n(ImageUploadViewer)" as Frontend
participant "Axios Instance" as Axios
participant "Handover Route\n(/api/handover)" as HandoverRoute
participant "Auth Middleware\n(verifyJWTToken)" as AuthMiddleware
participant "Upload Middleware\n(multer.array)" as UploadMiddleware
participant "Handover Controller\n(confirmOwnerHandover)" as HandoverController
participant "Cloudinary Service" as Cloudinary
participant "Booking Model" as BookingModel
participant "BookingHandover Model" as HandoverModel
database "MySQL Database" as DB

Owner -> Frontend: Chọn ít nhất 5 ảnh xe để upload
Frontend -> Frontend: Validate số lượng ảnh (5-10 ảnh)
Frontend -> Frontend: Tạo FormData với field "images"

Frontend -> Axios: POST /api/handover/{bookingId}/confirm-owner-handover\n(FormData với images)
Axios -> HandoverRoute: Request với FormData + Cookies\n(withCredentials: true)

HandoverRoute -> AuthMiddleware: verifyJWTToken(req, res, next)
AuthMiddleware -> AuthMiddleware: Extract JWT token từ cookies\nVerify token validity
AuthMiddleware -> HandoverRoute: Set req.user.userId = ownerId

HandoverRoute -> UploadMiddleware: uploadMiddleware = upload.array("images", 10)
UploadMiddleware -> UploadMiddleware: Validate file types (JPG, JPEG, PNG, WEBP)\nValidate file size (max 10MB each)\nStore files in memory buffer
UploadMiddleware -> HandoverRoute: Set req.files array

HandoverRoute -> HandoverController: confirmOwnerHandover(req, res)

HandoverController -> HandoverController: Extract bookingId từ req.params\nExtract ownerId từ req.user.userId

HandoverController -> BookingModel: findByPk(bookingId, include Vehicle)
BookingModel -> DB: SELECT bookings.*, vehicles.* FROM bookings\nJOIN vehicles ON bookings.vehicle_id = vehicles.vehicle_id\nWHERE booking_id = ?
DB -> BookingModel: Return booking với vehicle data
BookingModel -> HandoverController: Return booking object với vehicle

alt Booking không tồn tại
    HandoverController -> Frontend: 404 - "Booking không tồn tại"
else Booking tồn tại
    HandoverController -> HandoverController: Check booking.Vehicle.owner_id === ownerId
    
    alt Owner không sở hữu xe
        HandoverController -> Frontend: 403 - "Bạn không có quyền xác nhận bàn giao xe này"
    else Owner sở hữu xe
        HandoverController -> HandoverController: Validate req.files.length (5-10 ảnh)
        
        alt Số lượng ảnh < 5
            HandoverController -> Frontend: 400 - "Cần ít nhất 5 ảnh để xác nhận bàn giao"
        else if Số lượng ảnh > 10
            HandoverController -> Frontend: 400 - "Tối đa 10 ảnh cho mỗi lần bàn giao"
        else Số lượng ảnh hợp lệ (5-10)
            loop Cho mỗi file trong req.files
                HandoverController -> Cloudinary: upload_stream({\nfolder: "handover/pre-rental/{bookingId}",\nresource_type: "image"\n}).end(file.buffer)
                Cloudinary -> Cloudinary: Process ảnh từ memory buffer
                Cloudinary -> HandoverController: Return result.secure_url
            end
            
            HandoverController -> HandoverController: await Promise.all(uploadPromises)
            
            HandoverController -> HandoverModel: findOne({where: {booking_id: bookingId}})
            HandoverModel -> DB: SELECT * FROM booking_handovers WHERE booking_id = ?
            DB -> HandoverModel: Return handover data hoặc null
            HandoverModel -> HandoverController: Return handover object hoặc null
            
            alt Handover chưa tồn tại
                HandoverController -> HandoverModel: create({\nbooking_id: bookingId,\npre_rental_images: uploadedUrls,\nowner_handover_confirmed: true,\nhandover_time: new Date()\n})
                HandoverModel -> DB: INSERT INTO booking_handovers
                DB -> HandoverModel: Return created handover
                HandoverModel -> HandoverController: Return new handover object
            else Handover đã tồn tại
                HandoverController -> HandoverModel: update({\npre_rental_images: uploadedUrls,\nowner_handover_confirmed: true,\nhandover_time: new Date()\n})
                HandoverModel -> DB: UPDATE booking_handovers SET ...
                DB -> HandoverModel: Return updated rows
                HandoverModel -> HandoverController: Return update result
            end
            
            HandoverController -> Frontend: 200 - {\nsuccess: true,\nmessage: "Xác nhận bàn giao xe thành công",\ndata: {handover_id, uploadedImages, handover_time}\n}
            Frontend -> Frontend: Update UI state:\n- setConfirmedImages(uploadedUrls)\n- setIsConfirmed(true)\n- Clear localImages
            Frontend -> Owner: Display success message\n"Xác nhận bàn giao xe thành công!"
        end
    end
end

alt Có lỗi xảy ra (catch block)
    HandoverController -> Frontend: 500 - {\nsuccess: false,\nmessage: "Có lỗi xảy ra khi xác nhận bàn giao xe",\nerror: error.message\n}
end

@enduml