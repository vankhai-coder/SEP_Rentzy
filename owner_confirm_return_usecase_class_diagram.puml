@startuml Owner Confirm Return Use Case Class Diagram

title Owner Confirm Return Use Case Class Diagram

' Route Layer
class HandoverRoute {
  +POST /api/booking/:bookingId/confirm-owner-return
  +middleware: uploadMiddleware
  +middleware: verifyJWTToken
  +handler: confirmOwnerReturn()
}

' Middleware
class uploadMiddleware {
  +storage: multer.memoryStorage()
  +limits: 10MB fileSize
  +fileFilter: images only
  +array("images", 10)
}

class verifyJWTToken {
  +verify(token)
  +extractUserId()
}

' Controller Layer
class HandoverController {
  +confirmOwnerReturn(req, res)
  -validateBooking()
  -validateBookingStatus()
  -validateImageCount()
  -uploadToCloudinary()
  -updateHandoverRecord()
}

' Model Layer
class Booking {
  +booking_id: string
  +vehicle_id: string
  +status: string
  +total_amount: number
  +findOne()
  +include: Vehicle
}

class BookingHandover {
  +handover_id: string
  +booking_id: string
  +post_rental_images: array
  +owner_return_confirmed: boolean
  +return_time: datetime
  +findOne()
  +create()
  +update()
}

class Vehicle {
  +vehicle_id: string
  +owner_id: string
  +name: string
  +model: string
}

class User {
  +user_id: string
  +username: string
  +email: string
}

' External Service
class CloudinaryService {
  +upload_stream()
  +folder: "handover/post-rental/{bookingId}"
  +resource_type: "image"
  +secure_url: string
}

' Relationships
HandoverRoute --> uploadMiddleware : uses
HandoverRoute --> verifyJWTToken : uses
HandoverRoute --> HandoverController : calls

uploadMiddleware --> HandoverController : processes files

verifyJWTToken --> HandoverController : provides ownerId

HandoverController --> Booking : validates
HandoverController --> BookingHandover : creates/updates
HandoverController --> CloudinaryService : uploads images

Booking --> Vehicle : includes
Vehicle --> User : belongs to owner

BookingHandover --> Booking : belongs to

' Notes
note right of HandoverController
  Validation Rules:
  - Booking must belong to owner
  - Booking status must be "in_progress"
  - Minimum 5 images required
  - Maximum 10 images allowed
  - Images uploaded to Cloudinary
  - Sets owner_return_confirmed = true
end note

note right of CloudinaryService
  Upload Configuration:
  - Folder: handover/post-rental/{bookingId}
  - Resource type: image
  - Returns secure_url for each image
  - Documents vehicle condition after rental
end note

note right of BookingHandover
  Image Storage:
  - pre_rental_images: before handover
  - post_rental_images: after return
  
  Used for damage comparison
  and dispute resolution
end note

@enduml