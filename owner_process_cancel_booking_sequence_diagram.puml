@startuml Owner Process Request Cancel Booking - Sequence Diagram

!define ACTOR_COLOR #FFE0B2
!define FRONTEND_COLOR #E1F5FE
!define BACKEND_COLOR #FFF3E0
!define DATABASE_COLOR #E8F5E8
!define MIDDLEWARE_COLOR #F3E5F5
!define SERVICE_COLOR #F0F4C3

actor "Owner" as owner ACTOR_COLOR
participant "CancelRequests\nComponent" as frontend FRONTEND_COLOR
participant "Confirmation\nModal" as modal FRONTEND_COLOR
participant "OwnerDashboard\nRoute" as route BACKEND_COLOR
participant "verifyJWTToken\nMiddleware" as authMiddleware MIDDLEWARE_COLOR
participant "requireOwner\nMiddleware" as ownerMiddleware MIDDLEWARE_COLOR
participant "OwnerDashboard\nController" as controller BACKEND_COLOR
participant "ValidationService" as validation SERVICE_COLOR
participant "RefundCalculation\nService" as refundService SERVICE_COLOR
participant "NotificationService" as notificationService SERVICE_COLOR
participant "Database\nTransaction" as transaction DATABASE_COLOR
participant "Database\n(Models)" as db DATABASE_COLOR

title Owner Process Request Cancel Booking - Sequence Flow

== Approve Cancel Request ==

owner -> frontend : Click "Approve" on cancel request
activate frontend

frontend -> frontend : handleApproveCancel(requestId)
frontend -> modal : Show confirmation modal
activate modal

modal --> owner : Display approval confirmation
owner -> modal : Confirm approval
modal -> frontend : onConfirm() callback
deactivate modal

frontend -> route : POST /api/owner/cancel-requests/:id/approve
activate route

route -> authMiddleware : verify JWT token
activate authMiddleware
authMiddleware -> authMiddleware : validate token & extract user_id
alt token invalid
    authMiddleware --> route : 401 Unauthorized
    route --> frontend : Error response
    frontend --> owner : Show authentication error
else token valid
    authMiddleware --> route : next() - user authenticated
    deactivate authMiddleware
    
    route -> ownerMiddleware : check owner role
    activate ownerMiddleware
    ownerMiddleware -> ownerMiddleware : validate owner permissions
    alt not owner
        ownerMiddleware --> route : 403 Forbidden
        route --> frontend : Error response
        frontend --> owner : Show authorization error
    else owner verified
        ownerMiddleware --> route : next() - owner authorized
        deactivate ownerMiddleware
        
        route -> controller : approveCancelRequest(req, res)
        activate controller
        
        controller -> transaction : Begin transaction
        activate transaction
        
        controller -> db : BookingCancellation.findByPk(id, {\n  include: [{\n    model: Booking,\n    include: [Vehicle, User]\n  }]\n})
        activate db
        db --> controller : cancellation with booking data
        deactivate db
        
        controller -> validation : validateOwnership(ownerId, cancellation)
        activate validation
        validation -> validation : check if owner owns the vehicle
        alt not owner's vehicle
            validation --> controller : false - ownership invalid
            controller --> route : 403 Forbidden - Not your vehicle
            route --> frontend : Error response
            frontend --> owner : Show ownership error
        else ownership valid
            validation --> controller : true - ownership valid
            deactivate validation
            
            controller -> validation : validateCancellationStatus(cancellation)
            activate validation
            validation -> validation : check if status allows processing
            alt invalid status
                validation --> controller : false - invalid status
                controller --> route : 400 Bad Request - Invalid status
                route --> frontend : Error response
                frontend --> owner : Show status error
            else status valid
                validation --> controller : true - status valid
                deactivate validation
                
                controller -> refundService : calculateRefundAmounts(booking, cancellationFee)
                activate refundService
                refundService -> refundService : calculate renter refund amount
                refundService -> refundService : calculate owner compensation
                refundService --> controller : { renterRefund, ownerRefund }
                deactivate refundService
                
                controller -> db : Booking.update({\n  status: 'cancelled'\n}, {\n  where: { booking_id },\n  transaction\n})
                activate db
                db --> controller : booking updated
                deactivate db
                
                controller -> db : BookingCancellation.update({\n  refund_status_renter: 'pending',\n  refund_status_owner: 'pending',\n  total_refund_for_renter: renterRefund,\n  total_refund_for_owner: ownerRefund\n}, {\n  where: { cancellation_id },\n  transaction\n})
                activate db
                db --> controller : cancellation updated
                deactivate db
                
                controller -> notificationService : createRenterNotification(booking, 'approved', null, transaction)
                activate notificationService
                notificationService -> db : Notification.create({\n  user_id: renter_id,\n  title: 'Yêu cầu hủy được duyệt',\n  content: 'Chủ xe đã duyệt yêu cầu hủy...',\n  type: 'booking_cancellation'\n}, { transaction })
                activate db
                db --> notificationService : notification created
                deactivate db
                deactivate notificationService
                
                controller -> notificationService : createAdminNotification(booking, 'refund_pending', transaction)
                activate notificationService
                notificationService -> db : Notification.create({\n  title: 'Cần duyệt hoàn tiền',\n  content: 'Có yêu cầu hoàn tiền cần xử lý...',\n  type: 'refund_approval'\n}, { transaction })
                activate db
                db --> notificationService : admin notification created
                deactivate db
                deactivate notificationService
                
                controller -> transaction : Commit transaction
                transaction --> controller : transaction committed
                deactivate transaction
                
                controller --> route : 200 OK - {\n  success: true,\n  message: 'Đã duyệt yêu cầu hủy',\n  data: { cancellation_id, refund_amounts }\n}
                deactivate controller
                
                route --> frontend : Success response
                deactivate route
                
                frontend -> frontend : handleConfirmAction() success
                frontend -> frontend : fetchCancelRequests() - refresh list
                frontend --> owner : Show success message & updated list
            end
        end
    end
end

deactivate frontend

== Reject Cancel Request ==

owner -> frontend : Click "Reject" on cancel request
activate frontend

frontend -> frontend : handleRejectCancel(requestId)
frontend -> modal : Show rejection modal with reason input
activate modal

modal --> owner : Display rejection form
owner -> modal : Enter rejection reason & confirm
modal -> modal : validateRejectionReason()
alt reason too short
    modal --> owner : Show validation error
else reason valid
    modal -> frontend : onConfirm(reason) callback
    deactivate modal
    
    frontend -> route : POST /api/owner/cancel-requests/:id/reject\n{ reason: "rejection reason" }
    activate route
    
    route -> authMiddleware : verify JWT token
    activate authMiddleware
    authMiddleware --> route : next() - token valid
    deactivate authMiddleware
    
    route -> ownerMiddleware : check owner role
    activate ownerMiddleware
    ownerMiddleware --> route : next() - owner verified
    deactivate ownerMiddleware
    
    route -> controller : rejectCancelRequest(req, res)
    activate controller
    
    controller -> transaction : Begin transaction
    activate transaction
    
    controller -> db : BookingCancellation.findByPk(id, {\n  include: [{\n    model: Booking,\n    include: [Vehicle, User]\n  }]\n})
    activate db
    db --> controller : cancellation with booking data
    deactivate db
    
    controller -> validation : validateOwnership(ownerId, cancellation)
    activate validation
    validation --> controller : true - ownership valid
    deactivate validation
    
    controller -> validation : validateCancellationStatus(cancellation)
    activate validation
    validation --> controller : true - status valid
    deactivate validation
    
    controller -> validation : validateRejectionReason(reason)
    activate validation
    validation -> validation : check reason length and content
    alt reason invalid
        validation --> controller : false - invalid reason
        controller --> route : 400 Bad Request - Invalid reason
        route --> frontend : Error response
        frontend --> owner : Show validation error
    else reason valid
        validation --> controller : true - reason valid
        deactivate validation
        
        controller -> db : Booking.update({\n  status: 'fully_paid'\n}, {\n  where: { booking_id },\n  transaction\n})
        activate db
        db --> controller : booking status restored
        deactivate db
        
        controller -> db : BookingCancellation.update({\n  refund_status_renter: 'rejected',\n  refund_reason_renter: reason\n}, {\n  where: { cancellation_id },\n  transaction\n})
        activate db
        db --> controller : cancellation updated with rejection
        deactivate db
        
        controller -> notificationService : createRenterNotification(booking, 'rejected', reason, transaction)
        activate notificationService
        notificationService -> db : Notification.create({\n  user_id: renter_id,\n  title: 'Yêu cầu hủy bị từ chối',\n  content: 'Chủ xe đã từ chối yêu cầu hủy. Lý do: ' + reason,\n  type: 'booking_cancellation'\n}, { transaction })
        activate db
        db --> notificationService : notification created
        deactivate db
        deactivate notificationService
        
        controller -> transaction : Commit transaction
        transaction --> controller : transaction committed
        deactivate transaction
        
        controller --> route : 200 OK - {\n  success: true,\n  message: 'Đã từ chối yêu cầu hủy',\n  data: { cancellation_id, reason }\n}
        deactivate controller
        
        route --> frontend : Success response
        deactivate route
        
        frontend -> frontend : handleConfirmAction() success
        frontend -> frontend : fetchCancelRequests() - refresh list
        frontend --> owner : Show success message & updated list
    end
end

deactivate frontend

== Error Handling Scenarios ==

note over owner, db
Error Handling:
1. Authentication errors (401) - Invalid/expired token
2. Authorization errors (403) - Not owner or wrong role
3. Validation errors (400) - Invalid status, missing reason
4. Not found errors (404) - Cancellation doesn't exist
5. Database errors (500) - Transaction failures
6. All errors trigger transaction rollback
7. User-friendly error messages displayed
end note

note over controller, notificationService
Business Rules:
1. Only vehicle owner can process cancel requests
2. Only pending cancellations can be processed
3. Approval sets refund status to 'pending' (requires admin approval)
4. Rejection restores booking to 'fully_paid' status
5. All actions create notifications for affected parties
6. Refund amounts calculated based on cancellation timing
7. Database transactions ensure data consistency
end note

@enduml